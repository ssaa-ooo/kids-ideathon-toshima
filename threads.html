<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>「としまアイデア」探検隊｜豊島区のリアルを見つけよう！</title>
    
    <!-- 自動転送スクリプト：github.ioへのアクセスを検知してVercelへ飛ばす -->
    <script>
        if (window.location.hostname.includes('github.io')) {
            window.location.href = window.location.href.replace('ssaa-ooo.github.io/kids-ideathon-toshima', 'kids-ideathon-toshima.vercel.app');
        }
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; color: #333; background-color: #f8fafc; }
        .thread-card { transition: all 0.3s ease; }
        .thread-card:hover { transform: translateY(-3px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
        .map-bg { background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 20px 20px; }
        .shimmer { background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .break-phrase { display: inline-block; }
    </style>
</head>
<body class="antialiased map-bg text-slate-800">

    <header class="bg-white/80 backdrop-blur-md border-b sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center text-slate-800">
            <a href="index.html" class="text-base md:text-xl font-black tracking-tighter text-blue-600 leading-none">
                としまキッズ<span class="text-orange-500">アイデアソン</span>
            </a>
            <nav class="hidden lg:flex space-x-6">
                <a href="index.html#about" class="text-sm font-bold text-gray-600 hover:text-blue-600">プロジェクトとは</a>
                <a href="explore.html" class="text-sm font-bold text-gray-600 hover:text-blue-600">AIメンター</a>
                <a href="creative/index.html" class="text-sm font-bold text-gray-600 hover:text-blue-600">ワークシート</a>
            </nav>
            <a href="explore.html" class="bg-blue-600 text-white px-4 py-2 rounded-full text-xs font-bold shadow-lg text-white">AIで相談する</a>
        </div>
    </header>

    <section class="py-12 px-6 text-center">
        <div class="container mx-auto max-w-4xl text-slate-800">
            <span class="inline-block bg-orange-100 text-orange-600 px-4 py-1 rounded-full text-xs font-black mb-4 tracking-widest uppercase text-orange-600">Social Listening</span>
            <h1 class="text-3xl md:text-5xl font-black mb-6 leading-tight text-slate-900">
                <span class="break-phrase">豊島区の</span><span class="break-phrase">「お題」発見：</span><br>
                <span class="text-blue-600 italic">としまアイデア</span>
            </h1>
            <p class="text-sm md:text-lg text-slate-600 font-medium">
                <span class="break-phrase">街の人たちが考えている</span><span class="break-phrase">「としまアイデア」を見てみよう！</span><br>
                <span class="break-phrase">SNSのリアルな声から、</span><span class="break-phrase">きみのアイデアを広げるヒントを見つけてね。</span>
            </p>
        </div>
    </section>

    <section class="container mx-auto px-4 max-w-5xl mb-20 text-slate-800">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="threads-container">
            <!-- Loading States -->
            <div class="shimmer h-48 rounded-2xl"></div>
            <div class="shimmer h-48 rounded-2xl"></div>
            <div class="shimmer h-48 rounded-2xl"></div>
        </div>

        <div id="error-message" class="hidden bg-red-50 border border-red-200 text-red-700 p-6 rounded-2xl text-center">
            <p class="font-bold">投稿を読み込めなかったみたいだ...</p>
            <p id="error-detail" class="text-sm mt-2">Vercelのドメインでアクセスしているか、APIの設定を確認してね！</p>
        </div>
    </section>

    <footer class="py-12 bg-slate-900 text-white text-center text-white">
        <p class="text-sm opacity-50">&copy; Toshima Kids Ideathon / SSAA Inc.</p>
    </footer>

    <script>
        async function fetchThreads() {
            const container = document.getElementById('threads-container');
            const errorMsg = document.getElementById('error-message');
            const errorDetail = document.getElementById('error-detail');

            try {
                // 自前のVercel API（/api/threads）を呼び出し
                // サーバー側で「としまアイデア」を検索するように変更済み
                const response = await fetch('/api/threads');
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.detail || result.error || '通信エラー');
                }

                container.innerHTML = ''; 

                // APIから返ってきた全ユーザーの検索結果を抽出
                const posts = result.data || [];

                if (posts.length > 0) {
                    posts.forEach(post => {
                        const date = new Date(post.timestamp).toLocaleDateString('ja-JP');
                        
                        // テキストが空、またはキーワードが含まれない場合はスキップ（二重チェック）
                        if (!post.text || !post.text.includes('としまアイデア')) return;

                        const card = `
                            <div class="thread-card bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex flex-col">
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center font-bold text-blue-600 shadow-inner text-blue-600">@</div>
                                    <div>
                                        <p class="text-xs font-black text-slate-900">${post.username || '探検家'}</p>
                                        <p class="text-[10px] text-slate-400">${date}</p>
                                    </div>
                                </div>
                                <p class="text-sm text-slate-700 leading-relaxed flex-grow mb-4 whitespace-pre-wrap">${post.text}</p>
                                <a href="${post.permalink}" target="_blank" class="text-[10px] font-bold text-blue-500 hover:underline">
                                    Threadsで詳しく見る →
                                </a>
                            </div>
                        `;
                        container.innerHTML += card;
                    });
                } 
                
                // フィルタリング後の結果がゼロだった場合
                if (container.innerHTML === '') {
                    container.innerHTML = '<p class="col-span-full text-center py-20 text-slate-400 font-bold">「としまアイデア」に関する投稿がまだ見つからないよ。あとで見てみてね！</p>';
                }

            } catch (error) {
                console.error("Threads Error:", error);
                container.classList.add('hidden');
                errorMsg.classList.remove('hidden');
                errorDetail.innerText = "エラー詳細: " + error.message;
            }
        }

        window.onload = fetchThreads;
    </script>
</body>
</html>
